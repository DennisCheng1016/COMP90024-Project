---
- hosts: 127.0.0.1
  become: yes
  tasks:

  - name: Remove existing Docker packages
    apt:
      name: 
        - docker
        - docker-engine
        - docker.io
        - containerd
        - runc
      state: absent

  - name: Install prerequisite packages
    apt:
      name: 
        - ca-certificates
        - curl
        - gnupg
      state: present

  - name: Create the directory for Docker keyring
    file:
      path: /etc/apt/keyrings
      state: directory
      mode: '0755'

  - name: Download Docker's official GPG key and move it to the keyring directory
    shell:
      cmd: curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

  - name: Change permission of Docker keyring
    file:
      path: /etc/apt/keyrings/docker.gpg
      mode: '0644'

  - name: Add Docker's APT repository
    shell:
      cmd: |
        echo \
        "deb [arch=\"$(dpkg --print-architecture)\" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
        jammy stable" | \
        sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

  - name: Update apt cache
    apt:
      update_cache: yes

  - name: Install Docker
    apt:
      name: 
        - docker-ce
        - docker-ce-cli
        - containerd.io
        - docker-buildx-plugin
        - docker-compose-plugin
      state: present

  - name: Install required Python packages
    pip:
      name:
        - docker
        - couchdb
        - configparser
        - Mastodon.py
      executable: pip3

  - name: Build Docker images
    command:
      cmd: docker build -t {{ item.name }} {{ item.path }}
    loop:
      - { name: 'aus-stream', path: '/home/ubuntu/COMP90024-Project/mastodon/aus-stream/' }
      - { name: 'aus-social-stream', path: '/home/ubuntu/COMP90024-Project/mastodon/aus-social-stream/' }

  - name: Run Docker container aus-stream
    docker_container:
      name: aus-stream-container
      image: aus-stream
      published_ports:
        - "8070:81"
      state: started

  - name: Run Docker container aus-social-stream
    docker_container:
      name: aus-social-stream-container
      image: aus-social-stream
      published_ports:
        - "7070:81"
      state: started
...
